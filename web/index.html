<!DOCTYPE html>
<html lang="zh-CN">
<!-- thanks: https://github.com/StudyLeaks/heartbeat/ -->

<head>
  <meta charset="UTF-8" />
  <title>Heart Beat StudyLeaks</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Young+Serif&display=swap');

    :root {
      --heart-speed: 1s
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }

    .heart {
      height: 90px;
      width: 90px;
      position: relative;
      animation: heart var(--heart-speed) ease infinite;
      margin: 10px;
    }

    .heart svg {
      width: 100%;
      height: 100%;
      fill: #f20044;
      filter: drop-shadow(0px 0px 20px #f20044);
    }

    .indicator {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .indicator span {
      font-size: 12px;
    }

    .indicator .indicator-item {
      margin-right: 7px;
    }

    .indicator .indicator-item:last-child {
      margin-right: 0;
      margin-left: 7px;
    }

    .indicator span,
    #heart-rate-number {
      font-family: 'Young Serif', serif;
      color: #ffffff;
      text-shadow:
        #f20044 0px 0px 20px,
        #f20044 0px 0px 40px,
        #fff 0px 0px 50px,
        #fff 0px 0px 60px;
    }

    #heart-rate-number {
      font-size: 55px;
      text-align: center;
    }


    @keyframes heart {
      0% {
        transform: scale(1);
      }

      15% {
        transform: scale(1.15);
      }

      30% {
        transform: scale(1);
      }

      45% {
        transform: scale(1.15);
      }

      60% {
        transform: scale(1);
      }
    }
  </style>
  <script>
    let maxRate = 0
    let minRate = 0
    function setHeartRate(heartRate) {
      document.documentElement.style.setProperty('--heart-speed', (60 / heartRate) + 's')
      document.getElementById('heart-rate-number').innerText = heartRate

      // 更新最高最低心率
      if (heartRate > maxRate) {
        maxRate = heartRate
        document.getElementById('heart-rate-max').innerText = maxRate
      }

      if (heartRate < minRate || minRate === 0) {
        minRate = heartRate
        document.getElementById('heart-rate-min').innerText = minRate
      }
    }

    function connectHeartRateStream() {
      // 使用 EventSource 建立 SSE 长连接
      const eventSource = new EventSource('/heartrate/stream')
      eventSource.onmessage = function (event) {
        try {
          let heartRate = Number(event.data)
          setHeartRate(heartRate)
          console.log("Heart Rate: ", heartRate)
        } catch (err) {
          console.error("Failed to parse heart rate:", err)
        }
      }

      eventSource.onerror = function (error) {
        console.error("EventSource error:", error)
        // 连接断开时，EventSource 会自动尝试重连
      }

      eventSource.onopen = function () {
        console.log("Connected to heart rate stream")
      }
    }

    if (document.location.protocol != 'file:') {
      connectHeartRateStream()
    } else {
      window.addEventListener('load', () => setHeartRate(60))
    }
  </script>
</head>

<body>
  <div id="heart" class="heart">
    <svg height="32" width="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0H24V24H0z" fill="none"></path>
      <path
        d="M16.5 3C19.538 3 22 5.5 22 9c0 7-7.5 11-10 12.5C9.5 20 2 16 2 9c0-3.5 2.5-6 5.5-6C9.36 3 11 4 12 5c1-1 2.64-2 4.5-2z">
      </path>
    </svg>
  </div>
  <div>
    <div id="heart-rate-number"></div>
    <!-- 最高最低 -->
    <div class="indicator">
      <div class="indicator-item">
        <span>H:</span> <span id="heart-rate-max"></span>
      </div>
      <div class="indicator-item">
        <span>L:</span> <span id="heart-rate-min"></span>
      </div>
    </div>
  </div>
</body>

</html>
